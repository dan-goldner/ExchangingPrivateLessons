rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* -------- users -------- */
    match /users/{uid} {

        allow read : if request.auth != null;
        allow write: if request.auth.uid == uid;


      match /takenLessons/{lessonId} {
        allow read : if request.auth.uid == uid;
        allow write: if false;
      }
    }

    /* -------- lessons -------- */
    match /lessons/{lessonId} {
      allow read : if true;
      allow write: if false;

      match /ratings/{raterId} {
        allow read : if request.auth != null;
        allow write: if false;
      }
    }

    /* -------- lessonRequests -------- */
    match /lessonRequests/{reqId} {
      allow read : if request.auth != null &&
        (request.auth.uid == resource.data.ownerId ||
         request.auth.uid == resource.data.requesterId);
      allow write: if false;
    }

    /* -------- chats -------- */
    match /chats/{chatId} {
      allow read : if request.auth != null &&
        request.auth.uid in resource.data.participantIds;
      allow write: if false;

      match /messages/{msgId} {
        allow read : if request.auth != null &&
          request.auth.uid in
            get(/databases/$(db)/documents/chats/$(chatId)).data.participantIds;
        allow write: if false;
      }
    }
  }
}
